<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>كشكولي</title>
  <style>
    body { font-family: 'Cairo', sans-serif; margin:0; padding:0; direction:rtl; background:#f4f9f9; height:100vh; overflow:hidden; }
    section { display:none; }
    #foldersPage, #lessonsPage { padding:1rem; height:100vh; overflow-y:auto; display:block; }
    .folder, .lesson { background:#fff; border:1px solid #ddd; border-radius:8px; padding:.75rem 1rem; margin:.5rem 0; position:relative; cursor:pointer; }
    .actions { position:absolute; left:10px; top:50%; transform:translateY(-50%); }
    .actions button { background:none; border:none; font-size:1rem; cursor:pointer; margin-right:5px; }
    button.primary { background:#4db6ac; color:#fff; border:none; padding:.5rem 1rem; border-radius:5px; cursor:pointer; margin:.25rem; }
    .hidden { display:none; }
    /* Editor */
    #editorPage { display:none; position:relative; height:100vh; }
    #editorToolbar { position:fixed; top:0; left:0; right:0; background:#4db6ac; display:flex; gap:.5rem; padding:.5rem; z-index:100; }
    #editorToolbar button, #editorToolbar input { background:#fff; color:#333; border:none; padding:.5rem; border-radius:4px; cursor:pointer; }
    #editor { position:absolute; top:50px; bottom:0; left:0; right:0; padding:1rem; overflow-y:auto; background:#fff; }
    .title-box { background:#dcedc8; border-left:5px solid #8bc34a; padding:.5rem; margin:.5rem 0; font-weight:bold; }
    .question-box { background:#fff3cd; border-right:5px solid #ffc107; padding:.5rem; margin:1rem 0 .5rem; font-weight:bold; }
    .answer-box { background:#e3f2fd; border-right:5px solid #2196f3; padding:.5rem; margin:0 0 1rem; }
    .editable-paragraph { margin:10px 0; min-height:20px; outline:none; }
    mark { background:yellow; }
    .fullscreen-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.8); display:flex; align-items:center; justify-content:center; z-index:9999; }
    .fullscreen-overlay img { max-width:90%; max-height:90%; }
    .close-btn { position:absolute; top:10px; right:20px; background:#f44336; color:#fff; border:none; padding:.5rem 1rem; border-radius:5px; cursor:pointer; }
    audio { display:block; margin:1rem 0; }
  </style>
</head>
<body>

<section id="foldersPage">
  <h2>موادك</h2>
  <div id="foldersList"></div>
  <button class="primary" onclick="addFolder()">+ مادة جديدة</button>
</section>

<section id="lessonsPage" class="hidden">
  <button class="primary" onclick="showPage('foldersPage')">◀ المواد</button>
  <h2 id="currentFolderTitle"></h2>
  <div id="lessonsList"></div>
  <button class="primary" onclick="addLesson()">+ درس جديد</button>
</section>

<section id="editorPage" class="hidden">
  <div id="editorToolbar">
    <button class="primary" onclick="backToLessons()">◀ الدروس</button>
    <button onclick="insertAtCursor('<div class=\\'title-box\\'>عنوان جديد</div><div><br></div>')">+ عنوان</button>
    <button onclick="insertAtCursor('<div class=\\'question-box\\'>س: ...</div><div><br></div>')">+ سؤال</button>
    <button onclick="insertAtCursor('<div class=\\'answer-box\\'>الإجابة:</div><div><br></div>')">+ إجابة</button>
    <button onclick="document.execCommand('bold')">عريض</button>
    <input type="color" id="colorPicker" title="لون الكتابة">
    <button id="recordBtn">🎙 تسجيل</button>
    <input type="text" id="searchBox" placeholder="بحث..." oninput="highlightText(this.value)">
  </div>
  <div id="editor" contenteditable="true"></div>
</section>

<script>
  let folders = JSON.parse(localStorage.getItem('folders'))||[];
  let currentFolder=null, currentLessonIndex=null;
  let currentColor='#000';
  let mediaRec, audioChunks=[], isRec=false;

  function saveData(){ localStorage.setItem('folders',JSON.stringify(folders)); }
  function showPage(id){ ['foldersPage','lessonsPage','editorPage'].forEach(p=>document.getElementById(p).classList.toggle('hidden', p!==id)); }

  function renderFolders(){ const el=document.getElementById('foldersList'); el.innerHTML='';
    folders.forEach((f,i)=>{ const d=document.createElement('div'); d.className='folder';
      d.innerHTML=`<span onclick="openFolder(${i})">${f.name}</span><div class=\"actions\"><button onclick=\"editFolder(${i})\">✏️</button><button onclick=\"deleteFolder(${i})\">🗑️</button></div>`;
      el.appendChild(d);
    });
  }
  function addFolder(){ const n=prompt('اسم المادة:'); if(n){ folders.push({name:n,lessons:[]}); saveData(); renderFolders(); }}
  function editFolder(i){ const n=prompt('اسم جديد:',folders[i].name); if(n){ folders[i].name=n; saveData(); renderFolders(); }}
  function deleteFolder(i){ if(confirm('حذف؟')){ folders.splice(i,1); saveData(); renderFolders(); }}
  function openFolder(i){ currentFolder=folders[i]; document.getElementById('currentFolderTitle').textContent=currentFolder.name; renderLessons(); showPage('lessonsPage'); }

  function renderLessons(){ const el=document.getElementById('lessonsList'); el.innerHTML='';
    currentFolder.lessons.forEach((ls,i)=>{ const d=document.createElement('div'); d.className='lesson';
      d.innerHTML=`<span onclick="openLesson(${i})">${ls.name}</span><div class=\"actions\"><button onclick=\"editLesson(${i})\">✏️</button><button onclick=\"deleteLesson(${i})\">🗑️</button></div>`;
      el.appendChild(d);
    });
  }
  function addLesson(){ const n=prompt('اسم الدرس:'); if(n){ currentFolder.lessons.push({name:n,content:''}); saveData(); renderLessons(); }}
  function editLesson(i){ const n=prompt('اسم جديد:',currentFolder.lessons[i].name); if(n){ currentFolder.lessons[i].name=n; saveData(); renderLessons(); }}
  function deleteLesson(i){ if(confirm('حذف؟')){ currentFolder.lessons.splice(i,1); saveData(); renderLessons(); }}
  function openLesson(i){ currentLessonIndex=i; const ed=document.getElementById('editor'); ed.innerHTML=currentFolder.lessons[i].content||''; showPage('editorPage'); startRecordingModule(); }
  function backToLessons(){ if(currentFolder&& currentLessonIndex!=null){ currentFolder.lessons[currentLessonIndex].content=document.getElementById('editor').innerHTML; saveData(); } showPage('lessonsPage'); }

  function insertAtCursor(html){ const sel=window.getSelection(); if(!sel.rangeCount)return; const r=sel.getRangeAt(0);
    const d=document.createElement('div'); d.innerHTML=html; const f=document.createDocumentFragment(); while(d.firstChild)f.appendChild(d.firstChild);
    r.deleteContents(); r.insertNode(f);
  }

  document.getElementById('colorPicker').addEventListener('input',e=>{ currentColor=e.target.value; document.execCommand('styleWithCSS',false,true); document.execCommand('foreColor',false,currentColor); });

  function highlightText(term){ const ed=document.getElementById('editor'); let raw=ed.innerHTML.replace(/<mark>|<\\/mark>/g,'');
    ed.innerHTML = term? raw.replace(new RegExp(term,'gi'),m=>`<mark>${m}</mark>`) : raw;
  }

  document.getElementById('editor').addEventListener('click',e=>{ if(e.target.id==='editor'){ const p=document.createElement('div'); p.className='editable-paragraph'; p.contentEditable=true; p.style.color=currentColor; document.getElementById('editor').appendChild(p); p.focus(); }});

  // Image fullscreen
  document.getElementById('editor').addEventListener('mousedown',e=>{ if(e.target.tagName==='IMG'){ let t=setTimeout(()=>{ const ov=document.createElement('div'); ov.className='fullscreen-overlay'; ov.innerHTML=`<img src=\"${e.target.src}\"/><button class=\"close-btn\" onclick=\"this.parentElement.remove()\">إغلاق</button>`; document.body.appendChild(ov); },500);
    e.target.onmouseup=()=>clearTimeout(t); e.target.onmouseout=()=>clearTimeout(t);
  }});

  // Audio Recording Module
  async function startRecordingModule(){ if(!mediaRec){ const stream=await navigator.mediaDevices.getUserMedia({audio:true}); mediaRec=new MediaRecorder(stream);
      mediaRec.ondataavailable=e=>{ if(e.data.size)audioChunks.push(e.data); };
      mediaRec.onstop=()=>{ const blob=new Blob(audioChunks,{type:'audio/mp3'}); const url=URL.createObjectURL(blob); const a=document.createElement('audio'); a.controls=true; a.src=url; document.getElementById('editor').appendChild(a); audioChunks=[]; };
    }
  }
  const recBtn=document.getElementById('recordBtn'); recBtn.onclick=async()=>{ if(!isRec){ await startRecordingModule(); mediaRec.start(); isRec=true; recBtn.textContent='⏹ إيقاف'; } else{ mediaRec.stop(); isRec=false; recBtn.textContent='🎙 تسجيل'; }};

  renderFolders(); showPage('foldersPage');
</script>
</body>
</html>
