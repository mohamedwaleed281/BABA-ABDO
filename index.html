 
<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>كشكولي</title>
  <style>
    /* ... (نفس التنسيق السابق) ... */
  </style>
</head>
<body>
  <header>كشكولي</header>
  <main>
    <!-- صفحة المواد -->
    <section id="foldersPage" class="active">
      <h2>موادك</h2>
      <div id="foldersList"></div>
      <button onclick="addFolder()">+ مادة جديدة</button>
    </section>

    <!-- صفحة الدروس -->
    <section id="lessonsPage">
      <button onclick="showPage('foldersPage')">◀ المواد</button>
      <h2 id="currentFolderTitle"></h2>
      <div id="lessonsList"></div>
      <button onclick="addLesson()">+ درس جديد</button>
    </section>

    <!-- صفحة المحرر -->
    <section id="editorPage">
      <button onclick="backToLessons()">◀ الدروس</button>
      <h2 id="lessonTitle"></h2>
      <div id="editorToolbar">
        <button onclick="insertAtCursor('<div class=&quot;title-box&quot;>عنوان جديد</div>')">+ عنوان</button>
        <button onclick="insertAtCursor('<div class=&quot;question-box&quot;>سؤال:</div>')">+ سؤال</button>
        <button onclick="insertAtCursor('<div class=&quot;answer-box&quot;>إجابة:</div>')">+ إجابة</button>
        <button onclick="document.execCommand('bold')">عريض</button>
        <button onclick="document.execCommand('italic')">مائل</button>
        <input type="color" id="colorPicker" title="اختر لون النص">
        <input type="file" id="imageInput" accept="image/*" title="إدراج صورة">
        <button id="recordBtn" aria-label="تسجيل صوتي">🎙 تسجيل</button>
        <input type="file" id="audioInput" accept="audio/*" title="إدراج مقطع صوتي">
        <input type="text" id="searchBox" placeholder="بحث..." title="بحث في المحتوى">
      </div>
      <div id="editor" contenteditable="true"></div>
    </section>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // البيانات
      let folders = JSON.parse(localStorage.getItem('folders')) || [];
      let currentFolderIndex = null;
      let currentLessonIndex = null;
      let currentColor = '#000000';
      let mediaRecorder, audioChunks = [], isRecording = false;

      // التخزين
      function saveData() {
        localStorage.setItem('folders', JSON.stringify(folders));
      }

      // التنقل بين الصفحات
      function showPage(id) {
        document.querySelectorAll('section').forEach(sec => sec.classList.remove('active'));
        document.getElementById(id).classList.add('active');
      }

      // إدارة المواد
      function renderFolders() {
        const list = document.getElementById('foldersList');
        list.innerHTML = '';
        folders.forEach((f, idx) => {
          const div = document.createElement('div');
          div.className = 'list-item folder';
          div.innerHTML = `
            <span onclick="openFolder(${idx})">${f.name}</span>
            <div class="actions">
              <button onclick="editFolder(${idx});event.stopPropagation()">✏️</button>
              <button onclick="deleteFolder(${idx});event.stopPropagation()">🗑️</button>
            </div>`;
          list.appendChild(div);
        });
      }
      window.renderFolders = renderFolders;

      function addFolder() {
        const name = prompt('اسم المادة:');
        if (name) {
          folders.push({ name: name.trim(), lessons: [] });
          saveData(); renderFolders();
        }
      }
      window.addFolder = addFolder;

      function openFolder(idx) {
        currentFolderIndex = idx;
        document.getElementById('currentFolderTitle').textContent = folders[idx].name;
        renderLessons();
        showPage('lessonsPage');
      }
      window.openFolder = openFolder;

      function editFolder(idx) {
        const name = prompt('اسم جديد للمادة:', folders[idx].name);
        if (name) {
          folders[idx].name = name.trim();
          saveData(); renderFolders();
        }
      }
      window.editFolder = editFolder;

      function deleteFolder(idx) {
        if (confirm('هل تريد حذف هذه المادة؟')) {
          folders.splice(idx, 1);
          saveData(); renderFolders();
          showPage('foldersPage');
        }
      }
      window.deleteFolder = deleteFolder;

      // إدارة الدروس
      function renderLessons() {
        const list = document.getElementById('lessonsList');
        list.innerHTML = '';
        folders[currentFolderIndex].lessons.forEach((ls, idx) => {
          const div = document.createElement('div');
          div.className = 'list-item lesson';
          div.innerHTML = `
            <span onclick="openLesson(${idx})">${ls.name}</span>
            <div class="actions">
              <button onclick="editLesson(${idx});event.stopPropagation()">✏️</button>
              <button onclick="deleteLesson(${idx});event.stopPropagation()">🗑️</button>
            </div>`;
          list.appendChild(div);
        });
      }
      window.renderLessons = renderLessons;

      function addLesson() {
        const name = prompt('اسم الدرس:');
        if (name) {
          folders[currentFolderIndex].lessons.push({ name: name.trim(), content: '' });
          saveData(); renderLessons();
        }
      }
      window.addLesson = addLesson;

      function openLesson(idx) {
        currentLessonIndex = idx;
        const lesson = folders[currentFolderIndex].lessons[idx];
        document.getElementById('lessonTitle').textContent = lesson.name;
        document.getElementById('editor').innerHTML = lesson.content;
        showPage('editorPage');
      }
      window.openLesson = openLesson;

      function editLesson(idx) {
        const name = prompt('اسم جديد للدرس:', folders[currentFolderIndex].lessons[idx].name);
        if (name) {
          folders[currentFolderIndex].lessons[idx].name = name.trim();
          saveData(); renderLessons();
        }
      }
      window.editLesson = editLesson;

      function deleteLesson(idx) {
        if (confirm('هل تريد حذف هذا الدرس؟')) {
          folders[currentFolderIndex].lessons.splice(idx, 1);
          saveData(); renderLessons();
        }
      }
      window.deleteLesson = deleteLesson;

      function backToFolders() {
        saveCurrentLesson();
        showPage('foldersPage');
      }
      window.backToFolders = backToFolders;

      function backToLessons() {
        saveCurrentLesson();
        showPage('lessonsPage');
      }
      window.backToLessons = backToLessons;

      function saveCurrentLesson() {
        if (currentLessonIndex !== null) {
          folders[currentFolderIndex].lessons[currentLessonIndex].content =
            document.getElementById('editor').innerHTML;
          saveData();
        }
      }

      // محرر النص
      function insertAtCursor(html) {
        const sel = window.getSelection();
        if (!sel.rangeCount) return;
        const range = sel.getRangeAt(0);
        const el = document.createElement('div');
        el.innerHTML = html;
        const frag = document.createDocumentFragment();
        while (el.firstChild) frag.appendChild(el.firstChild);
        range.deleteContents();
        range.insertNode(frag);
        range.collapse(false);
        sel.removeAllRanges();
        sel.addRange(range);
      }
      window.insertAtCursor = insertAtCursor;

      // تغيير اللون المباشر
      document.getElementById('colorPicker').addEventListener('input', e => {
        const color = e.target.value;
        document.execCommand('styleWithCSS', false, true);
        document.execCommand('foreColor', false, color);
      });

      // إدراج الصور مع تكبير مطوّل
      const imageInput = document.getElementById('imageInput');
      imageInput.addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          const img = document.createElement('img');
          img.src = reader.result;
          img.style.maxWidth = '150px';
          img.style.cursor = 'pointer';
          img.addEventListener('mousedown', mEvent => {
            let timer = setTimeout(() => {
              const overlay = document.createElement('div');
              overlay.className = 'fullscreen-overlay';
              overlay.innerHTML = `<img src="${img.src}"><button class="close-btn" onclick="this.parentElement.remove()">إغلاق</button>`;
              document.body.appendChild(overlay);
            }, 500);
            img.onmouseup = img.onmouseout = () => clearTimeout(timer);
          });
          insertAtCursor(img.outerHTML);
        };
        reader.readAsDataURL(file);
        e.target.value = '';
      });

      // إدراج مقطع صوتي
      const audioInput = document.getElementById('audioInput');
      audioInput.addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          const audio = document.createElement('audio');
          audio.controls = true;
          audio.src = reader.result;
          document.getElementById('editor').appendChild(audio);
        };
        reader.readAsDataURL(file);
        e.target.value = '';
      });

      // البحث وتظليل
      document.getElementById('searchBox').addEventListener('input', e => {
        const term = e.target.value.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const editor = document.getElementById('editor');
        let html = editor.innerHTML.replace(/<mark>|<\/mark>/gi, '');
        if (term) {
          html = html.replace(new RegExp(term, 'gi'), m => `<mark>${m}</mark>`);
        }
        editor.innerHTML = html;
      });

      // فقرة جديدة عند النقر
      document.getElementById('editor').addEventListener('click', e => {
        const div = document.createElement('div');
        div.className = 'editable-paragraph';
        div.contentEditable = 'true';
        div.style.color = currentColor;
        document.getElementById('editor').appendChild(div);
        div.focus();
      });

      // تسجيل صوتي
      async function initRecorder() {
        if (!navigator.mediaDevices || !window.MediaRecorder) return;
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e => {
          if (e.data.size) audioChunks.push(e.data);
        };
        mediaRecorder.onstop = () => {
          const blob = new Blob(audioChunks, { type: 'audio/webm' });
          const url = URL.createObjectURL(blob);
          const audio = document.createElement('audio');
          audio.controls = true;
          audio.src = url;
          document.getElementById('editor').appendChild(audio);
          audioChunks = [];
        };
      }

      const recordBtn = document.getElementById('recordBtn');
      recordBtn.addEventListener('click', async () => {
        if (!mediaRecorder) await initRecorder();
        if (!isRecording) {
          mediaRecorder.start();
          isRecording = true;
          recordBtn.textContent = '⏹ إيقاف';
          recordBtn.style.background = '#e53935';
        } else {
          mediaRecorder.stop();
          isRecording = false;
          recordBtn.textContent = '🎙 تسجيل';
          recordBtn.style.background = '';
        }
      });

      // بدء التطبيق
      renderFolders();
      showPage('foldersPage');
    });
  </script>
</body>
</html>
