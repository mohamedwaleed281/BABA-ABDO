<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ÙƒØ´ÙƒÙˆÙ„ÙŠ</title>
  <style>
    /* Ù†ÙØ³ Ø£Ù†Ù…Ø§Ø· CSS Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© */
  </style>
</head>
<body>
  <header>ÙƒØ´ÙƒÙˆÙ„ÙŠ</header>
  <main>
    <!-- ØµÙØ­Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ -->
    <section id="foldersPage" class="active">
      <h2>Ù…ÙˆØ§Ø¯Ùƒ</h2>
      <div id="foldersList"></div>
      <button onclick="addFolder()">+ Ù…Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
    </section>

    <!-- ØµÙØ­Ø© Ø§Ù„Ø¯Ø±ÙˆØ³ -->
    <section id="lessonsPage">
      <button onclick="showPage('foldersPage')">â—€ Ø§Ù„Ù…ÙˆØ§Ø¯</button>
      <h2 id="currentFolderTitle"></h2>
      <div id="lessonsList"></div>
      <button onclick="addLesson()">+ Ø¯Ø±Ø³ Ø¬Ø¯ÙŠØ¯</button>
    </section>

    <!-- ØµÙØ­Ø© Ø§Ù„Ù…Ø­Ø±Ø± -->
    <section id="editorPage">
      <button onclick="backToLessons()">â—€ Ø§Ù„Ø¯Ø±ÙˆØ³</button>
      <h2 id="lessonTitle"></h2>
      <div id="editorToolbar">
        <button onclick="insertAtCursor('<div class=&quot;title-box&quot;>Ø¹Ù†ÙˆØ§Ù† Ø¬Ø¯ÙŠØ¯</div>')">+ Ø¹Ù†ÙˆØ§Ù†</button>
        <button onclick="insertAtCursor('<div class=&quot;question-box&quot;>Ø³Ø¤Ø§Ù„:</div>')">+ Ø³Ø¤Ø§Ù„</button>
        <button onclick="insertAtCursor('<div class=&quot;answer-box&quot;>Ø¥Ø¬Ø§Ø¨Ø©:</div>')">+ Ø¥Ø¬Ø§Ø¨Ø©</button>
        <button onclick="document.execCommand('bold')">Ø¹Ø±ÙŠØ¶</button>
        <button onclick="document.execCommand('italic')">Ù…Ø§Ø¦Ù„</button>
        <input type="color" id="colorPicker" title="Ø§Ø®ØªØ± Ù„ÙˆÙ† Ø§Ù„Ù†Øµ">
        <input type="file" id="imageInput" accept="image/*" title="Ø¥Ø¯Ø±Ø§Ø¬ ØµÙˆØ±Ø©">
        <input type="file" id="audioInput" accept="audio/*" title="Ø¥Ø¯Ø±Ø§Ø¬ Ù…Ù‚Ø·Ø¹ ØµÙˆØªÙŠ">
        <input type="text" id="searchBox" placeholder="Ø¨Ø­Ø«..." title="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø­ØªÙˆÙ‰">
      </div>
      <div id="editor" contenteditable="true"></div>
    </section>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      let folders = [];
      let currentFolderIndex = null;
      let currentLessonIndex = null;
      let currentColor = '#000000';

      // Ø¥Ø¹Ø¯Ø§Ø¯ IndexedDB
      const request = indexedDB.open('KashkooliDB', 1);
      request.onupgradeneeded = (event) => {
        const db = event.target.result;
        db.createObjectStore('folders', { keyPath: 'id', autoIncrement: true });
      };
      request.onsuccess = (event) => {
        const db = event.target.result;
        loadFolders(db);
      };

      function loadFolders(db) {
        const transaction = db.transaction('folders', 'readonly');
        const store = transaction.objectStore('folders');
        const getAll = store.getAll();
        getAll.onsuccess = () => {
          folders = getAll.result;
          renderFolders();
        };
      }

      function saveData(db) {
        const transaction = db.transaction('folders', 'readwrite');
        const store = transaction.objectStore('folders');
        folders.forEach(folder => store.put(folder));
      }

      // Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª
      function showPage(id) {
        document.querySelectorAll('section').forEach(sec => sec.classList.remove('active'));
        document.getElementById(id).classList.add('active');
      }

      // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¯
      function renderFolders() {
        const list = document.getElementById('foldersList');
        list.innerHTML = '';
        folders.forEach((f, idx) => {
          const div = document.createElement('div');
          div.className = 'list-item folder';
          div.innerHTML = `
            <span onclick="openFolder(${idx})">${f.name}</span>
            <div class="actions">
              <button onclick="editFolder(${idx});event.stopPropagation()">âœï¸</button>
              <button onclick="deleteFolder(${idx});event.stopPropagation()">ğŸ—‘ï¸</button>
            </div>`;
          list.appendChild(div);
        });
      }

      function addFolder() {
        const name = prompt('Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©:');
        if (name) {
          folders.push({ name: name.trim(), lessons: [] });
          saveData(request.result);
          renderFolders();
        }
      }

      function openFolder(idx) {
        currentFolderIndex = idx;
        document.getElementById('currentFolderTitle').textContent = folders[idx].name;
        renderLessons();
        showPage('lessonsPage');
      }

      function editFolder(idx) {
        const name = prompt('Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…Ø§Ø¯Ø©:', folders[idx].name);
        if (name) {
          folders[idx].name = name.trim();
          saveData(request.result);
          renderFolders();
        }
      }

      function deleteFolder(idx) {
        if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø§Ø¯Ø©ØŸ')) {
          folders.splice(idx, 1);
          saveData(request.result);
          renderFolders();
          showPage('foldersPage');
        }
      }

      // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯Ø±ÙˆØ³
      function renderLessons() {
        const list = document.getElementById('lessonsList');
        list.innerHTML = '';
        folders[currentFolderIndex].lessons.forEach((ls, idx) => {
          const div = document.createElement('div');
          div.className = 'list-item lesson';
          div.innerHTML = `
            <span onclick="openLesson(${idx})">${ls.name}</span>
            <div class="actions">
              <button onclick="editLesson(${idx});event.stopPropagation()">âœï¸</button>
              <button onclick="deleteLesson(${idx});event.stopPropagation()">ğŸ—‘ï¸</button>
            </div>`;
          list.appendChild(div);
        });
      }

      function addLesson() {
        const name = prompt('Ø§Ø³Ù… Ø§Ù„Ø¯Ø±Ø³:');
        if (name) {
          folders[currentFolderIndex].lessons.push({ name: name.trim(), content: '' });
          saveData(request.result);
          renderLessons();
        }
      }

      function openLesson(idx) {
        currentLessonIndex = idx;
        const lesson = folders[currentFolderIndex].lessons[idx];
        document.getElementById('lessonTitle').textContent = lesson.name;
        document.getElementById('editor').innerHTML = lesson.content;
        showPage('editorPage');
      }

      function editLesson(idx) {
        const name = prompt('Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¯Ø±Ø³:', folders[currentFolderIndex].lessons[idx].name);
        if (name) {
          folders[currentFolderIndex].lessons[idx].name = name.trim();
          saveData(request.result);
          renderLessons();
        }
      }

      function deleteLesson(idx) {
        if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³ØŸ')) {
          folders[currentFolderIndex].lessons.splice(idx, 1);
          saveData(request.result);
          renderLessons();
        }
      }

      function backToFolders() {
        saveCurrentLesson();
        showPage('foldersPage');
      }

      function backToLessons() {
        saveCurrentLesson();
        showPage('lessonsPage');
      }

      function saveCurrentLesson() {
        if (currentLessonIndex !== null) {
          folders[currentFolderIndex].lessons[currentLessonIndex].content =
            document.getElementById('editor').innerHTML;
          saveData(request.result);
        }
      }

      // Ù…Ø­Ø±Ø± Ø§Ù„Ù†Øµ
      function insertAtCursor(html) {
        const sel = window.getSelection();
        if (!sel.rangeCount) return;
        const range = sel.getRangeAt(0);
        const el = document.createElement('div');
        el.innerHTML = html;
        const frag = document.createDocumentFragment();
        while (el.firstChild) frag.appendChild(el.firstChild);
        range.deleteContents();
        range.insertNode(frag);
        range.collapse(false);
        sel.removeAllRanges();
        sel.addRange(range);
      }

      // ØªØºÙŠÙŠØ± Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
      document.getElementById('colorPicker').addEventListener('input', e => {
        const color = e.target.value;
        document.execCommand('styleWithCSS', false, true);
        document.execCommand('foreColor', false, color);
      });

      // Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„ØµÙˆØ± Ù…Ø¹ ØªÙƒØ¨ÙŠØ± Ù…Ø·ÙˆÙ‘Ù„
      const imageInput = document.getElementById('imageInput');
      imageInput.addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          const img = document.createElement('img');
          img.src = reader.result;
          img.style.maxWidth = '150px';
          img.style.cursor = 'pointer';
          img.addEventListener('click', () => {
            const overlay = document.createElement('div');
            overlay.className = 'fullscreen-overlay';
            overlay.innerHTML = `<img src="${img.src}" style="max-width: 100%;"><button class="close-btn" onclick="this.parentElement.remove()">Ø¥ØºÙ„Ø§Ù‚</button>`;
            document.body.appendChild(overlay);
          });
          insertAtCursor(img.outerHTML);
        };
        reader.readAsDataURL(file);
        e.target.value = '';
      });

      // Ø¥Ø¯Ø±Ø§Ø¬ Ù…Ù‚Ø·Ø¹ ØµÙˆØªÙŠ
      const audioInput = document.getElementById('audioInput');
      audioInput.addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          const audioContainer = document.createElement('div');
          audioContainer.className = 'audio-container';
          const audio = document.createElement('audio');
          audio.controls = true;
          audio.src = reader.result;

          const moveButton = document.createElement('button');
          moveButton.innerHTML = 'ğŸ”„';
          moveButton.onclick = () => {
            // Ù…Ù†Ø·Ù‚ Ù„ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ù…Ù‚Ø·Ø¹ ÙÙŠ Ø§Ù„Ù…Ø­Ø±Ø±
            alert('ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ù…Ù‚Ø·Ø¹ ÙÙŠ Ø§Ù„Ù…Ø­Ø±Ø±.');
          };

          audioContainer.appendChild(audio);
          audioContainer.appendChild(moveButton);
          document.getElementById('editor').appendChild(audioContainer);
        };
        reader.readAsDataURL(file);
        e.target.value = '';
      });

      // Ø§Ù„Ø¨Ø­Ø« ÙˆØªØ¸Ù„ÙŠÙ„
      document.getElementById('searchBox').addEventListener('input', e => {
        const term = e.target.value.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const editor = document.getElementById('editor');
        let html = editor.innerHTML.replace(/<mark>|<\/mark>/gi, '');
        if (term) {
          html = html.replace(new RegExp(term, 'gi'), m => `<mark>${m}</mark>`);
        }
        editor.innerHTML = html;
      });

      // ÙÙ‚Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø±
      document.getElementById('editor').addEventListener('click', e => {
        const div = document.createElement('div');
        div.className = 'editable-paragraph';
        div.contentEditable = 'true';
        div.style.color = currentColor;
        document.getElementById('editor').appendChild(div);
        div.focus();
      });

      // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
      renderFolders();
      showPage('foldersPage');

      // ØªÙƒØ¨ÙŠØ± ÙˆØªØµØºÙŠØ± Ø§Ù„ØµÙØ­Ø©
      let scale = 1;
      document.addEventListener('wheel', (event) => {
        if (event.ctrlKey) {
          event.preventDefault();
          scale += event.deltaY * -0.001;
          scale = Math.min(Math.max(0.5, scale), 2); // ØªØ­Ø¯ÙŠØ¯ Ù†Ø·Ø§Ù‚ Ø§Ù„ØªÙƒØ¨ÙŠØ±
          document.body.style.transform = `scale(${scale})`;
          document.body.style.transformOrigin = '0 0';
        }
      });
    });
  </script>
</body>
</html>
