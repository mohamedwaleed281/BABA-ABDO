<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ÙƒØ´ÙƒÙˆÙ„ÙŠ</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo&display=swap');
    body {
      font-family: 'Cairo', sans-serif;
      margin: 0; padding: 0;
      background: #f4f9f9;
      direction: rtl;
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      color: #333;
    }
    header {
      background: #4db6ac;
      color: #fff;
      text-align: center;
      padding: 1.2rem;
      font-size: 1.8rem;
      font-weight: 700;
      flex-shrink: 0;
      user-select: none;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    main {
      flex: 1;
      display: flex;
      overflow: hidden;
      flex-direction: column;
    }
    section {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
      display: none;
      flex-direction: column;
      animation: fadeIn 0.3s ease;
    }
    section.active {
      display: flex;
    }
    h2 {
      margin-top: 0;
      font-weight: 700;
      font-size: 1.4rem;
      color: #2c3e50;
    }
    button {
      background: #4db6ac;
      color: #fff;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 6px;
      cursor: pointer;
      margin: 0.5rem 0;
      font-size: 1rem;
      font-weight: 600;
      box-shadow: 0 3px 8px rgba(77,182,172,0.4);
      transition: background 0.3s ease;
      user-select: none;
      align-self: flex-start;
    }
    button:hover, button:focus {
      background: #409588;
      outline: none;
      box-shadow: 0 0 10px #409588;
    }
    button:disabled {
      background: #a0a0a0;
      cursor: not-allowed;
      box-shadow: none;
    }
    .list-item {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 0.85rem 1rem;
      margin: 0.5rem 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      box-shadow: 0 1px 4px rgba(0,0,0,0.07);
      transition: background 0.2s ease;
    }
    .list-item:hover {
      background: #e0f2f1;
    }
    .list-item span {
      font-size: 1.1rem;
      font-weight: 600;
      max-width: 80%;
      word-break: break-word;
    }
    .actions {
      display: flex;
      gap: 0.7rem;
      flex-shrink: 0;
    }
    .actions button {
      background: none;
      color: #666;
      font-size: 1.3rem;
      padding: 0;
      border-radius: 5px;
      transition: color 0.3s ease;
    }
    .actions button:hover {
      color: #4db6ac;
      transform: scale(1.2);
    }
    /* Ù…Ø­Ø±Ø± Ø§Ù„Ø¯Ø±Ø³ */
    #editorToolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      background: #4db6ac;
      padding: 0.6rem 0.8rem;
      position: sticky;
      top: 0;
      z-index: 20;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      user-select: none;
    }
    #editorToolbar button,
    #editorToolbar input {
      background: #fff;
      color: #333;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      transition: background 0.25s ease;
      display: flex;
      align-items: center;
    }
    #editorToolbar button:hover,
    #editorToolbar button:focus {
      background: #d0eadf;
      outline: none;
      box-shadow: 0 0 10px #4db6ac;
    }
    #editorToolbar input[type="color"],
    #editorToolbar input[type="file"],
    #editorToolbar input[type="text"] {
      padding: 0;
      width: 34px;
      height: 34px;
      box-shadow: none;
      cursor: pointer;
    }
    #searchBox {
      flex-grow: 1;
      max-width: 160px;
      padding-left: 0.5rem;
      border-radius: 6px;
    }
    #searchBox::placeholder {
      color: #999;
      font-size: 0.95rem;
    }
    #editor {
      flex: 1;
      background: #fff;
      border-radius: 10px;
      border: 1px solid #ccc;
      padding: 1.3rem 1.5rem;
      margin-top: 0.6rem;
      overflow-y: auto;
      outline: none;
      line-height: 1.6;
      font-size: 1.15rem;
      color: #222;
      box-shadow: inset 0 0 8px #ddd;
      white-space: pre-wrap;
      word-wrap: break-word;
      min-height: 350px;
      user-select: text;
    }
    .title-box {
      background: #dcedc8;
      border-left: 6px solid #8bc34a;
      padding: 0.65rem 1rem;
      margin: 0.7rem 0;
      font-weight: 700;
      font-size: 1.25rem;
      border-radius: 6px;
      box-shadow: inset 2px 0 #7cb342;
    }
    .question-box {
      background: #fff3cd;
      border-right: 6px solid #ffc107;
      padding: 0.6rem 1rem;
      margin: 1.1rem 0 0.6rem;
      font-weight: 700;
      font-size: 1.1rem;
      border-radius: 6px;
      box-shadow: inset -2px 0 #ffb300;
    }
    .answer-box {
      background: #e3f2fd;
      border-right: 6px solid #2196f3;
      padding: 0.6rem 1rem;
      margin: 0 0 1.2rem;
      font-size: 1rem;
      border-radius: 6px;
      box-shadow: inset -2px 0 #1e88e5;
    }
    mark {
      background: #fffd75;
    }
    .editable-paragraph {
      margin: 1rem 0;
      min-height: 26px;
      outline: none;
    }
    audio {
      display: block;
      margin: 1rem 0;
      width: 100%;
      max-width: 450px;
      border-radius: 8px;
      box-shadow: 0 0 10px #a3d5d3 inset;
    }
    /* Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± ÙÙŠ ÙƒØ§Ù…Ù„ Ø§Ù„Ø´Ø§Ø´Ø© */
    .fullscreen-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.85);
      display: flex; align-items: center; justify-content: center;
      z-index: 9999;
    }
    .fullscreen-overlay img {
      max-width: 90%;
      max-height: 90%;
      cursor: zoom-out;
      border-radius: 12px;
      box-shadow: 0 0 15px #555;
      user-select: none;
    }
    .fullscreen-overlay .close-btn {
      position: absolute;
      top: 20px; right: 30px;
      background: #f44336;
      color: #fff;
      border: none;
      padding: 0.6rem 1.1rem;
      border-radius: 7px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 700;
      box-shadow: 0 0 8px #f44336;
      user-select: none;
      transition: background 0.3s ease;
    }
    .fullscreen-overlay .close-btn:hover {
      background: #c62828;
      box-shadow: 0 0 12px #c62828;
    }
    /* Ù…Ø¤Ø«Ø± Ø¸Ù‡ÙˆØ± Ø§Ù„Ù‚Ø³Ù… */
    @keyframes fadeIn {
      from {opacity: 0;}
      to {opacity: 1;}
    }
    /* Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
    @media (max-width: 600px) {
      body {
        font-size: 16px;
      }
      main {
        height: calc(100vh - 58px);
      }
      #editorToolbar {
        gap: 0.4rem;
        padding: 0.4rem 0.5rem;
      }
      #editorToolbar button, #editorToolbar input[type="color"], #editorToolbar input[type="file"], #editorToolbar input[type="text"] {
        font-size: 0.9rem;
        padding: 0.4rem 0.6rem;
        border-radius: 5px;
        min-width: 36px;
        min-height: 36px;
      }
      #searchBox {
        max-width: 120px;
      }
      #editor {
        font-size: 1rem;
      }
      .list-item span {
        font-size: 1rem;
      }
      button, button.primary {
        font-size: 0.95rem;
        padding: 0.45rem 1rem;
      }
      header {
        font-size: 1.4rem;
        padding: 0.85rem;
      }
    }
  </style>
</head>
<body>
  <header>ÙƒØ´ÙƒÙˆÙ„ÙŠ</header>
  <main>
    <!-- ØµÙØ­Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ -->
    <section id="foldersPage" class="active" aria-label="ØµÙØ­Ø© Ø§Ù„Ù…ÙˆØ§Ø¯">
      <h2>Ù…ÙˆØ§Ø¯Ùƒ</h2>
      <div id="foldersList" role="list" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ø¯"></div>
      <button type="button" id="addFolderBtn" aria-label="Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©">+ Ù…Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
    </section>

    <!-- ØµÙØ­Ø© Ø§Ù„Ø¯Ø±ÙˆØ³ -->
    <section id="lessonsPage" aria-label="ØµÙØ­Ø© Ø§Ù„Ø¯Ø±ÙˆØ³">
      <button type="button" id="backToFoldersBtn" aria-label="Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙˆØ§Ø¯">â—€ Ø§Ù„Ù…ÙˆØ§Ø¯</button>
      <h2 id="currentFolderTitle"></h2>
      <div id="lessonsList" role="list" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø±ÙˆØ³"></div>
      <button type="button" id="addLessonBtn" aria-label="Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³ Ø¬Ø¯ÙŠØ¯">+ Ø¯Ø±Ø³ Ø¬Ø¯ÙŠØ¯</button>
    </section>

    <!-- ØµÙØ­Ø© Ø§Ù„Ù…Ø­Ø±Ø± -->
    <section id="editorPage" aria-label="ØµÙØ­Ø© ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¯Ø±Ø³">
      <button type="button" id="backToLessonsBtn" aria-label="Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø¯Ø±ÙˆØ³">â—€ Ø§Ù„Ø¯Ø±ÙˆØ³</button>
      <h2 id="lessonTitle"></h2>
      <div id="editorToolbar" role="toolbar" aria-label="Ø£Ø¯ÙˆØ§Øª ØªØ­Ø±ÙŠØ± Ø§Ù„Ù†Øµ">
        <button type="button" aria-label="Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ÙˆØ§Ù†" data-insert-html="&lt;div class=&quot;title-box&quot;&gt;Ø¹Ù†ÙˆØ§Ù† Ø¬Ø¯ÙŠØ¯&lt;/div&gt;">+ Ø¹Ù†ÙˆØ§Ù†</button>
        <button type="button" aria-label="Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„" data-insert-html="&lt;div class=&quot;question-box&quot;&gt;Ø³Ø¤Ø§Ù„:&lt;/div&gt;">+ Ø³Ø¤Ø§Ù„</button>
        <button type="button" aria-label="Ø¥Ø¶Ø§ÙØ© Ø¥Ø¬Ø§Ø¨Ø©" data-insert-html="&lt;div class=&quot;answer-box&quot;&gt;Ø¥Ø¬Ø§Ø¨Ø©:&lt;/div&gt;">+ Ø¥Ø¬Ø§Ø¨Ø©</button>
        <button type="button" id="boldBtn" aria-label="Ù†Øµ Ø¹Ø±ÙŠØ¶ (Ctrl+B)">Ø¹Ø±ÙŠØ¶</button>
        <button type="button" id="italicBtn" aria-label="Ù†Øµ Ù…Ø§Ø¦Ù„ (Ctrl+I)">Ù…Ø§Ø¦Ù„</button>
        <input type="color" id="colorPicker" title="Ø§Ø®ØªØ± Ù„ÙˆÙ† Ø§Ù„Ù†Øµ" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ù„ÙˆÙ† Ø§Ù„Ù†Øµ">
        <input type="file" id="imageInput" accept="image/*" title="Ø¥Ø¯Ø±Ø§Ø¬ ØµÙˆØ±Ø©" aria-label="Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ù„Ø¥Ø¯Ø±Ø§Ø¬Ù‡Ø§">
        <button type="button" id="recordBtn" aria-label="ØªØ³Ø¬ÙŠÙ„ ØµÙˆØªÙŠ">ğŸ™ ØªØ³Ø¬ÙŠÙ„</button>
        <input type="text" id="searchBox" placeholder="Ø¨Ø­Ø«..." title="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø­ØªÙˆÙ‰" aria-label="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù†ØµÙŠ">
      </div>
      <div id="editor" contenteditable="true" spellcheck="true" aria-multiline="true" role="textbox" aria-label="Ù…Ø­Ø±Ø± Ù†Øµ Ø§Ù„Ø¯Ø±Ø³">Ø§ÙƒØªØ¨ Ù‡Ù†Ø§...</div>
    </section>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Ø§Ù„ØªØ¹Ø§Ø±ÙŠÙ ÙˆØ§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
      let folders = JSON.parse(localStorage.getItem('folders')) || [];
      let currentFolderIndex = null;
      let currentLessonIndex = null;
      let currentColor = '#000000';

      let mediaRecorder = null;
      let audioChunks = [];
      let isRecording = false;

      // Ø¹Ù†Ø§ØµØ± DOM
      const foldersList = document.getElementById('foldersList');
      const lessonsList = document.getElementById('lessonsList');
      const editor = document.getElementById('editor');
      const currentFolderTitle = document.getElementById('currentFolderTitle');
      const lessonTitle = document.getElementById('lessonTitle');
      const backToFoldersBtn = document.getElementById('backToFoldersBtn');
      const backToLessonsBtn = document.getElementById('backToLessonsBtn');
      const addFolderBtn = document.getElementById('addFolderBtn');
      const addLessonBtn = document.getElementById('addLessonBtn');
      const recordBtn = document.getElementById('recordBtn');
      const imageInput = document.getElementById('imageInput');
      const colorPicker = document.getElementById('colorPicker');
      const searchBox = document.getElementById('searchBox');
      const editorToolbar = document.getElementById('editorToolbar');

      // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      function saveData() {
        localStorage.setItem('folders', JSON.stringify(folders));
      }

      // Ø¹Ø±Ø¶ ØµÙØ­Ø© Ù…Ø­Ø¯Ø¯Ø©
      function showPage(id) {
        document.querySelectorAll('section').forEach(section => {
          section.classList.toggle('active', section.id === id);
        });
      }

      // Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§Ø¯
      function renderFolders() {
        foldersList.innerHTML = '';
        folders.forEach((folder, idx) => {
          const div = document.createElement('div');
          div.className = 'list-item folder';
          div.innerHTML = `
            <span tabindex="0" role="button" aria-pressed="false" aria-label="ÙØªØ­ Ø§Ù„Ù…Ø§Ø¯Ø© ${folder.name}">${folder.name}</span>
            <div class="actions">
              <button aria-label="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø§Ø¯Ø© ${folder.name}">âœï¸</button>
              <button aria-label="Ø­Ø°Ù Ø§Ù„Ù…Ø§Ø¯Ø© ${folder.name}">ğŸ—‘ï¸</button>
            </div>
          `;
          // Ø¥Ø¶Ø§ÙØ© Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙˆØ§Ù„Ù†Ù‚Ø±
          const span = div.querySelector('span');
          span.addEventListener('click', () => openFolder(idx));
          span.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openFolder(idx); } });
          // Ø£Ø²Ø±Ø§Ø± ØªØ¹Ø¯ÙŠÙ„ ÙˆØ­Ø°Ù
          const [editBtn, delBtn] = div.querySelectorAll('.actions button');
          editBtn.addEventListener('click', e => {
            e.stopPropagation();
            editFolder(idx);
          });
          delBtn.addEventListener('click', e => {
            e.stopPropagation();
            deleteFolder(idx);
          });
          foldersList.appendChild(div);
        });
      }

      // Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©
      function addFolder() {
        const name = prompt('Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©:');
        if (name && name.trim()) {
          folders.push({ name: name.trim(), lessons: [] });
          saveData();
          renderFolders();
          showPage('foldersPage');
          addFolderBtn.focus();
        }
      }

      // ÙØªØ­ Ù…Ø§Ø¯Ø©
      function openFolder(idx) {
        currentFolderIndex = idx;
        currentLessonIndex = null;
        currentFolderTitle.textContent = folders[idx].name;
        renderLessons();
        showPage('lessonsPage');
        addLessonBtn.focus();
      }

      // ØªØ¹Ø¯ÙŠÙ„ Ù…Ø§Ø¯Ø©
      function editFolder(idx) {
        const name = prompt('Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…Ø§Ø¯Ø©:', folders[idx].name);
        if (name && name.trim()) {
          folders[idx].name = name.trim();
          saveData();
          renderFolders();
        }
      }

      // Ø­Ø°Ù Ù…Ø§Ø¯Ø©
      function deleteFolder(idx) {
        if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø§Ø¯Ø©ØŸ')) {
          folders.splice(idx, 1);
          saveData();
          renderFolders();
          showPage('foldersPage');
          addFolderBtn.focus();
        }
      }

      // Ø¹Ø±Ø¶ Ø§Ù„Ø¯Ø±ÙˆØ³
      function renderLessons() {
        lessonsList.innerHTML = '';
        if (currentFolderIndex === null) return;
        folders[currentFolderIndex].lessons.forEach((lesson, idx) => {
          const div = document.createElement('div');
          div.className = 'list-item lesson';
          div.innerHTML = `
            <span tabindex="0" role="button" aria-pressed="false" aria-label="ÙØªØ­ Ø§Ù„Ø¯Ø±Ø³ ${lesson.name}">${lesson.name}</span>
            <div class="actions">
              <button aria-label="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø³ ${lesson.name}">âœï¸</button>
              <button aria-label="Ø­Ø°Ù Ø§Ù„Ø¯Ø±Ø³ ${lesson.name}">ğŸ—‘ï¸</button>
            </div>
          `;
          // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù†Ù‚Ø± ÙˆØ§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯
          const span = div.querySelector('span');
          span.addEventListener('click', () => openLesson(idx));
          span.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openLesson(idx); } });
          // Ø£Ø²Ø±Ø§Ø± ØªØ¹Ø¯ÙŠÙ„ ÙˆØ­Ø°Ù
          const [editBtn, delBtn] = div.querySelectorAll('.actions button');
          editBtn.addEventListener('click', e => {
            e.stopPropagation();
            editLesson(idx);
          });
          delBtn.addEventListener('click', e => {
            e.stopPropagation();
            deleteLesson(idx);
          });
          lessonsList.appendChild(div);
        });
      }

      // Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³
      function addLesson() {
        if (currentFolderIndex === null) {
          alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø§Ø¯Ø© Ø£ÙˆÙ„Ø§Ù‹.');
          return;
        }
        const name = prompt('Ø§Ø³Ù… Ø§Ù„Ø¯Ø±Ø³:');
        if (name && name.trim()) {
          folders[currentFolderIndex].lessons.push({ name: name.trim(), content: '' });
          saveData();
          renderLessons();
          addLessonBtn.focus();
        }
      }

      // ÙØªØ­ Ø¯Ø±Ø³
      function openLesson(idx) {
        if (currentFolderIndex === null) return;
        currentLessonIndex = idx;
        const lesson = folders[currentFolderIndex].lessons[idx];
        lessonTitle.textContent = lesson.name;
        editor.innerHTML = lesson.content || '<p><br></p>';
        showPage('editorPage');
        editor.focus();
      }

      // ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø±Ø³
      function editLesson(idx) {
        const name = prompt('Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¯Ø±Ø³:', folders[currentFolderIndex].lessons[idx].name);
        if (name && name.trim()) {
          folders[currentFolderIndex].lessons[idx].name = name.trim();
          saveData();
          renderLessons();
        }
      }

      // Ø­Ø°Ù Ø¯Ø±Ø³
      function deleteLesson(idx) {
        if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³ØŸ')) {
          folders[currentFolderIndex].lessons.splice(idx, 1);
          saveData();
          renderLessons();
        }
      }

      // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ÙˆØ§Ø¯
      function backToFolders() {
        saveCurrentLesson();
        showPage('foldersPage');
        addFolderBtn.focus();
      }

      // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¯Ø±ÙˆØ³
      function backToLessons() {
        saveCurrentLesson();
        showPage('lessonsPage');
        addLessonBtn.focus();
      }

      // Ø­ÙØ¸ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¯Ø±Ø³ Ø§Ù„Ø­Ø§Ù„ÙŠ
      function saveCurrentLesson() {
        if (currentFolderIndex === null || currentLessonIndex === null) return;
        folders[currentFolderIndex].lessons[currentLessonIndex].content = editor.innerHTML;
        saveData();
      }

      // Ø¥Ø¯Ø±Ø§Ø¬ HTML ÙÙŠ Ù…ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¤Ø´Ø±
      function insertAtCursor(html) {
        const sel = window.getSelection();
        if (!sel.rangeCount) return;
        const range = sel.getRangeAt(0);
        const el = document.createElement('div');
        el.innerHTML = html;
        const frag = document.createDocumentFragment();
        while (el.firstChild) frag.appendChild(el.firstChild);
        range.deleteContents();
        range.insertNode(frag);
        // ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¤Ø´Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø¶Ø§Ù
        range.collapse(false);
        sel.removeAllRanges();
        sel.addRange(range);
        editor.focus();
      }

      // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¯Ø±Ø§Ø¬ ÙÙŠ Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª
      editorToolbar.querySelectorAll('button[data-insert-html]').forEach(btn => {
        btn.addEventListener('click', () => insertAtCursor(btn.getAttribute('data-insert-html')));
      });
      // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†ØµÙŠ
      document.getElementById('boldBtn')?.addEventListener('click', () => {
        document.execCommand('bold', false, null);
        editor.focus();
      });
      document.getElementById('italicBtn')?.addEventListener('click', () => {
        document.execCommand('italic', false, null);
        editor.focus();
      });

      // ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø§Ù„Ù†Øµ
      colorPicker.addEventListener('input', (e) => {
        document.execCommand('styleWithCSS', false, true);
        document.execCommand('foreColor', false, e.target.value);
        editor.focus();
      });

      // Ø¥Ø¯Ø±Ø§Ø¬ ØµÙˆØ±Ø© Ù…Ù† Ù…Ù„Ù
      imageInput.addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          const img = document.createElement('img');
          img.src = reader.result;
          img.style.maxWidth = '160px';
          img.style.cursor = 'pointer';
          img.alt = 'ØµÙˆØ±Ø© Ù…Ø¶Ø§ÙØ©';
          img.addEventListener('mousedown', event => {
            let timer = setTimeout(() => {
              const overlay = document.createElement('div');
              overlay.className = 'fullscreen-overlay';
              overlay.innerHTML = `<img src="${img.src}" alt="ØµÙˆØ±Ø© Ù…ÙˆØ³Ø¹Ø©"><button class="close-btn" aria-label="Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…ÙƒØ¨Ø±Ø©">Ø¥ØºÙ„Ø§Ù‚</button>`;
              document.body.appendChild(overlay);
              // Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…ÙƒØ¨Ø±Ø© Ø£Ùˆ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
              overlay.querySelector('img').addEventListener('click', () => overlay.remove());
              overlay.querySelector('.close-btn').addEventListener('click', () => overlay.remove());
            }, 500);
            img.onmouseup = img.onmouseout = () => clearTimeout(timer);
          });
          insertAtCursor(img.outerHTML);
        };
        reader.readAsDataURL(file);
        imageInput.value = ''; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø±ÙØ¹ Ù…Ø¬Ø¯Ø¯Ø§
      });

      // Ø¨Ø­Ø« ÙˆØªØ¸Ù„ÙŠÙ„ ÙÙŠ Ø§Ù„Ù…Ø­Ø±Ø± (ØªØ¸Ù„ÙŠÙ„ Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©)
      searchBox.addEventListener('input', () => {
        const term = searchBox.value.trim().replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); // escaping regex chars
        if (!term) {
          editor.innerHTML = editor.innerHTML.replace(/<\/?mark>/g, ''); // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ¸Ù„ÙŠÙ„ Ø¥Ù† ÙˆØ¬Ø¯
          return;
        }
        const regex = new RegExp(term, 'gi');
        // Ø­ØªÙ‰ Ù„Ø§ ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ³ÙˆÙ…ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø·Ø±ÙŠÙ‚Ø© Ø¢Ù…Ù†Ø© â€“ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù†Øµ Ø§Ù„Ø®Ø§Ù… ÙÙ‚Ø·
        // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ù‡ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ù‚Ø¯ ØªÙØ²ÙŠÙ„ Ø¨Ø¹Ø¶ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø¨ØºÙŠØ± Ù‚ØµØ¯ ÙÙŠ Ø­Ø§Ù„Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©
        // Ù„Ùˆ Ø£Ø±Ø¯Øª Ø­Ù„Ù‹Ø§ Ù…Ø¹Ù‚Ø¯Ù‹Ø§ ÙŠÙ†Ø¨ØºÙŠ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙƒØªØ¨Ø© Ù…Ø«Ù„ mark.js
        let text = editor.textContent;
        let markedHTML = text.replace(regex, match => `<mark>${match}</mark>`);
        editor.innerHTML = markedHTML;
      });

      // Ø¥Ø¶Ø§ÙØ© ÙÙ‚Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± ÙÙŠ Ù…Ø³Ø§Ø­Ø© ÙØ§Ø±ØºØ© ÙÙŠ Ø§Ù„Ù…Ø­Ø±Ø±
      editor.addEventListener('click', e => {
        if (e.target === editor) {
          const p = document.createElement('p');
          p.className = 'editable-paragraph';
          p.contentEditable = 'true';
          p.style.color = currentColor;
          p.innerHTML = '<br>';
          editor.appendChild(p);
          const range = document.createRange();
          range.setStart(p, 0);
          range.collapse(true);
          const sel = window.getSelection();
          sel.removeAllRanges();
          sel.addRange(range);
          p.focus();
        }
      });

      // Ø­ÙØ¸ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„ØªÙØ§Ø¯ÙŠ ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      editor.addEventListener('input', saveCurrentLesson);

      // ØªØ³Ø¬ÙŠÙ„ ØµÙˆØªÙŠ Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ù…ØªØµÙØ­Ø§Øª
      async function initMediaRecorder() {
        if (!navigator.mediaDevices || !window.MediaRecorder) {
          recordBtn.disabled = true;
          recordBtn.title = 'Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù…ØªØµÙØ­Ùƒ';
          return;
        }
        if (mediaRecorder) return;
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(stream);
          mediaRecorder.ondataavailable = e => {
            if (e.data.size > 0) audioChunks.push(e.data);
          };
          mediaRecorder.onstop = () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            const url = URL.createObjectURL(audioBlob);
            const audio = document.createElement('audio');
            audio.controls = true;
            audio.src = url;
            editor.appendChild(audio);
            audioChunks = [];
            saveCurrentLesson();
          };
        } catch (err) {
          alert('Ù„Ù… Ù†Ø³ØªØ·Ø¹ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†: ' + err.message);
          recordBtn.disabled = true;
        }
      }

      recordBtn.addEventListener('click', async () => {
        if (!mediaRecorder) await initMediaRecorder();
        if (!mediaRecorder) return;
        if (!isRecording) {
          mediaRecorder.start();
          isRecording = true;
          recordBtn.textContent = 'â¹ Ø¥ÙŠÙ‚Ø§Ù';
          recordBtn.style.background = '#e53935';
          recordBtn.setAttribute('aria-pressed', 'true');
        } else {
          mediaRecorder.stop();
          isRecording = false;
          recordBtn.textContent = 'ğŸ™ ØªØ³Ø¬ÙŠÙ„';
          recordBtn.style.background = '';
          recordBtn.setAttribute('aria-pressed', 'false');
        }
      });

      // Ø§Ø®ØªØµØ§Ø±Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ (Ctrl+B, Ctrl+I Ù„Ù„ØªÙ†Ø³ÙŠÙ‚)
      editor.addEventListener('keydown', e => {
        if (e.ctrlKey && !e.shiftKey && !e.altKey) {
          switch (e.key.toLowerCase()) {
            case 'b':
              e.preventDefault();
              document.execCommand('bold');
              break;
            case 'i':
              e.preventDefault();
              document.execCommand('italic');
              break;
          }
        }
      });

      // Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„ ÙˆØ§Ù„Ø¥Ø¶Ø§ÙØ©
      backToFoldersBtn.addEventListener('click', backToFolders);
      backToLessonsBtn.addEventListener('click', backToLessons);
      addFolderBtn.addEventListener('click', addFolder);
      addLessonBtn.addEventListener('click', addLesson);

      // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
      renderFolders();
      showPage('foldersPage');
      addFolderBtn.focus();
    });
  </script>
</body>
</html>
</content>
</create_file>
