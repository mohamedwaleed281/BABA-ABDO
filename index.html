<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>كشكولي</title>
  <style>
    body {
      margin: 0; padding: 0;
      font-family: 'Cairo', sans-serif;
      direction: rtl; height: 100vh;
      overflow: hidden;
    }
    /* صفحات التنقل */
    #foldersPage, #lessonsPage { padding: 1rem; }
    /* محرر الدرس */
    #editorPage {
      display: none;
      position: relative;
      height: 100vh;
      background: #f4f9f9;
    }
    /* شريط الأدوات في أعلى المحرر */
    #editorToolbar {
      position: fixed;
      top: 0; left: 0; right: 0;
      background: #4db6ac; padding: 0.5rem;
      display: flex; align-items: center;
      gap: 0.5rem; z-index: 100;
    }
    #editorToolbar button, 
    #editorToolbar input[type=color] {
      background: white; color: #333;
      border: none; padding: 0.5rem;
      border-radius: 4px; cursor: pointer;
    }
    /* المنطقة القابلة للكتابة */
    #editor {
      position: absolute;
      top: 50px; /* ارتفاع الشريط */
      bottom: 0; left: 0; right: 0;
      padding: 1rem;
      overflow-y: auto;
      background: white;
    }
    /* بطاقات العنوان والسؤال والإجابة */
    .title-box { background: #dcedc8; padding: 0.5rem; margin: 0.5rem 0; }
    .question-box { background: #fff3cd; padding: 0.5rem; margin: 0.5rem 0; }
    .answer-box   { background: #e3f2fd; padding: 0.5rem; margin: 0.5rem 0; }
  </style>
</head>
<body>

  <!-- صفحة المواد -->
  <section id="foldersPage">
    <h2>مجلداتك</h2>
    <div id="foldersList"></div>
    <button onclick="addFolder()">+ إضافة مادة</button>
  </section>

  <!-- صفحة الدروس -->
  <section id="lessonsPage" class="hidden">
    <button onclick="backToFolders()">◀︎ المواد</button>
    <h2 id="currentFolderTitle"></h2>
    <div id="lessonsList"></div>
    <button onclick="addLesson()">+ إضافة درس</button>
  </section>

  <!-- صفحة تحرير الدرس -->
  <section id="editorPage">
    <!-- شريط الأدوات -->
    <div id="editorToolbar">
      <button onclick="backToLessons()">◀︎ الدروس</button>
      <button onclick="insertAtCursor('<div class=&quot;title-box&quot; contenteditable=&quot;true&quot;>عنوان جديد</div><div><br></div>')">+ عنوان</button>
      <button onclick="insertAtCursor('<div class=&quot;question-box&quot; contenteditable=&quot;true&quot;>س: ...</div><div><br></div>')">+ سؤال</button>
      <button onclick="document.execCommand('bold')">عريض</button>
      <input type="color" id="colorPicker" title="لون الكتابة">
      <input type="file" id="imageInput" accept="image/*" title="إضافة صورة">
    </div>
    <!-- المنطقة القابلة للكتابة -->
    <div id="editor" contenteditable="true"></div>
  </section>

  <script>
    // بيانات
    let folders = JSON.parse(localStorage.getItem("folders")) || [];
    let currentFolder = null, currentLesson = null;

    function saveData() {
      localStorage.setItem("folders", JSON.stringify(folders));
    }
    function show(id) {
      document.getElementById("foldersPage").classList.toggle("hidden", id!=="foldersPage");
      document.getElementById("lessonsPage").classList.toggle("hidden", id!=="lessonsPage");
      document.getElementById("editorPage").classList.toggle("hidden", id!=="editorPage");
    }

    // مجلدات
    function addFolder() {
      const name = prompt("اسم المادة:");
      if (!name) return;
      folders.push({name, lessons: []});
      saveData(); renderFolders();
    }
    function renderFolders() {
      const list = document.getElementById("foldersList");
      list.innerHTML="";
      folders.forEach((f,i)=> {
        const d=document.createElement("div");
        d.textContent=f.name;
        d.onclick=()=>openFolder(i);
        list.appendChild(d);
      });
    }
    function openFolder(i) {
      currentFolder = folders[i];
      document.getElementById("currentFolderTitle").textContent = currentFolder.name;
      renderLessons(); show("lessonsPage");
    }
    function backToFolders(){ show("foldersPage"); }

    // دروس
    function addLesson() {
      const name = prompt("اسم الدرس:");
      if (!name) return;
      currentFolder.lessons.push({name,content:""});
      saveData(); renderLessons();
    }
    function renderLessons() {
      const list = document.getElementById("lessonsList");
      list.innerHTML="";
      currentFolder.lessons.forEach((ls,i)=>{
        const d=document.createElement("div");
        d.textContent=ls.name;
        d.onclick=()=>openLesson(i);
        list.appendChild(d);
      });
    }
    function openLesson(i) {
      currentLesson = currentFolder.lessons[i];
      document.getElementById("editor").innerHTML = currentLesson.content || "";
      show("editorPage");
    }
    function backToLessons() {
      if (currentLesson) {
        currentLesson.content = document.getElementById("editor").innerHTML;
        saveData();
      }
      show("lessonsPage");
    }

    // إدراج HTML في مكان المؤشر
    function insertAtCursor(html) {
      const sel=window.getSelection();
      if (!sel.rangeCount) return;
      const range=sel.getRangeAt(0);
      const el=document.createElement("div"); el.innerHTML=html;
      const frag=document.createDocumentFragment();
      let node;
      while(node=el.firstChild) frag.appendChild(node);
      range.deleteContents();
      range.insertNode(frag);
    }

    // أداة الألوان للكتابة الجديدة
    document.getElementById("colorPicker")
      .addEventListener("input", e=>{
        document.execCommand("styleWithCSS",false,true);
        document.execCommand("foreColor",false,e.target.value);
      });

    // رفع صورة
    document.getElementById("imageInput")
      .addEventListener("change", e=>{
        const file=e.target.files[0]; if(!file) return;
        const reader=new FileReader();
        reader.onload=()=>{
          const img=document.createElement("img");
          img.src=reader.result;
          img.style.maxWidth="150px";
          img.oncontextmenu = ()=>false;
          img.onmousedown = null;
          // فتح ملء الشاشة على الضغط مطوّل
          img.addEventListener("mousedown", startLongPress);
          function startLongPress(evt) {
            let timeout = setTimeout(()=>{
              const overlay=document.createElement("div");
              overlay.className="fullscreen-image";
              overlay.innerHTML=`<img src="${img.src}" onclick="this.parentElement.remove()">`;
              document.body.appendChild(overlay);
            },800);
            img.onmouseup=()=>clearTimeout(timeout);
            img.onmouseout=()=>clearTimeout(timeout);
          }
          insertAtCursor(img.outerHTML);
        };
        reader.readAsDataURL(file);
      });

    // بدء
    renderFolders();
    show("foldersPage");
  </script>
</body>
</html>
